Object.prototype.clone=function(){var d=this instanceof Array?[]:{};for(i in this)"clone"!=i&&(d[i]=this[i]&&"object"==typeof this[i]?this[i].clone():this[i]);return d};
var piece=function(d,b,e,f){d=d||[[1]];b=b||"#000000";null===e&&(e=-1*d.length);null===f&&(f=d[0].length+1);this.getStructure=function(){return d.clone()};this.getTop=function(){return e};this.getLeft=function(){return f};this.getWidth=function(){return d[0].length};this.getHeight=function(){return d.length};this.getColor=function(){return b};this.drop=function(){e+=1};this.moveLeft=function(){f-=1};this.moveRight=function(){f+=1};this.setLeft=function(c){f=c};this.rotate=function(c){var b=Array(d[0].length),
a,h;for(a=0;a<b.length;++a){b[a]=Array(d.length);for(h=0;h<b[0].length;++h)"ccw"===c?b[a][h]=d[h][b.length-a-1]:"cw"===c&&(b[a][h]=d[b[0].length-h-1][a])}d=b}},level=function(d,b,e,f){var c;if(null===d||void 0===d){d=Array(e);for(c=0;c<e;++c)d[c]=Array(b)}else b=d[0].length,e=d.length;var g=function(){var a=Math.floor(b/2);switch(Math.floor(7*Math.random())){case 0:return new piece([[1],[1],[1],[1]],"#8FEBE9",null,a);case 1:return new piece([[0,1,1],[1,1,0]],"#3ED936",null,a-2);case 2:return new piece([[1,
1,0],[0,1,1]],"#F23E22",null,a-2);case 3:return new piece([[1,1,1],[0,1,0]],"#B21DCC",null,a-2);case 4:return new piece([[0,1],[0,1],[1,1]],"#194CC2",null,a-1);case 5:return new piece([[1,0],[1,0],[1,1]],"#F2B022",null,a-1);case 6:return new piece([[1,1],[1,1]],"#F2ED50",null,a-1)}},a=f||g();this.getWidth=function(){return d[0].length};this.getHeight=function(){return d.length};this.getStructure=function(){return d.clone()};this.moveActiveLeft=function(){this.isObstructedLeft()||a.moveLeft()};this.moveActiveRight=
function(){this.isObstructedRight()||a.moveRight()};this.dropActive=function(){this.isObstructedBottom()||a.drop()};this.rotateActive=function(){a.rotate("cw");a.getLeft()+a.getWidth()>=b&&a.setLeft(b-a.getWidth())};this.getActive=function(){return a.clone()};this.isObstructedLeft=function(){if(0>=a.getLeft())return!0;var b=a.getStructure();for(c=0;c<a.getHeight();c++)for(j=0;j<a.getWidth();j++)if(1===b[c][j]){var e=a.getTop();0>e&&(e=0);if(void 0!=d[e+c][a.getLeft()+j-1])return!0;break}return!1};
this.isObstructedRight=function(){if(a.getLeft()+a.getWidth()>=b)return!0;var h=a.getStructure();for(c=0;c<a.getHeight();c++)for(j=a.getWidth()-1;0<=j;j--)if(1===h[c][j]){var e=a.getTop();0>e&&(e=0);if(void 0!=d[e+c][a.getLeft()+j+1])return!0;break}return!1};this.isObstructedBottom=function(){var b,f,g=a.getStructure();for(c=a.getHeight()-1;0<=c;c--){f=1+c+a.getTop();if(f>=e)return!0;if(0>f)break;for(b=0;b<=a.getWidth()-1;b++)if(1===g[c][b]&&void 0!=d[f][a.getLeft()+b])return!0}return!1};this.placeActive=
function(){var b,e=a.getStructure();for(c=0;c<a.getHeight();++c)for(b=0;b<a.getWidth();++b)1==e[c][b]&&0<=c+a.getTop()&&(d[c+a.getTop()][b+a.getLeft()]=a.getColor());a=g()};this.getFullRows=function(){var a,f=[];for(c=0;c<e;c++)for(a=0;a<b&&!(void 0===d[c][a]);a++)a===b-1&&f.push(c);return f};this.clearRows=function(a){for(c=0;c<a.length;c++)d.splice(a[c],1),d.unshift(Array(b))}},game=function(d,b,e){var d=d||document.getElementById("level"),b=b||new b(null,8,16),f=0,c=0,e=e||0,g="play",a=[],h=!0,
n=0,o=new Image;d.width=20*b.getWidth();d.height=20*b.getHeight();o.src="block.png";window.addEventListener("keydown",function(a){switch(a.keyCode){case 37:"play"==g&&b.moveActiveLeft();break;case 38:"play"==g&&b.rotateActive();break;case 39:"play"==g&&b.moveActiveRight();break;case 40:"play"==g&&b.dropActive();break;case 19:q();break;case 80:q()}},!1);var q=this.pause=function(){"play"===g?g="stop":(g="play",p(),l(),m())},l=function(){if(b.isObstructedBottom()){if(0>b.getActive().getTop())g="stop",
document.getElementById("gameover").style.display="block";b.placeActive()}else b.dropActive();c+=a.length;f=Math.floor(c/10);b.clearRows(a);document.getElementById("score").innerHTML=e;document.getElementById("level-number").innerHTML=f;a=b.getFullRows();switch(a.length){case 1:e+=40*(f+1);break;case 2:e+=100*(f+1);break;case 3:e+=300*(f+1);break;case 4:e+=1200*(f+1)}"stop"!==g&&setTimeout(l,500-15*f)},p=function(){k.clearRect(0,0,20*b.getWidth(),20*b.getHeight());k.fillStyle="rgb(0, 31, 0)";var c,
d,e=b.getActive(),f,l,m;f=e.getStructure();l=e.getLeft();m=e.getTop();k.fillStyle=e.getColor();for(c=0;c<e.getHeight();++c)for(d=0;d<e.getWidth();++d)1===f[c][d]&&(k.fillRect(20*(d+l),20*(c+m),20,20),k.drawImage(o,20*(d+l),20*(c+m)));e=b.getStructure();h=h?!1:!0;for(c=0;c<b.getHeight();++c){d=!1;for(f=0;f<a.length;f++)c===a[f]&&(d=!0);for(f=0;f<b.getWidth();++f)if(void 0!=e[c][f])k.fillStyle=d&&h?"#ffffff":e[c][f],k.fillRect(20*f,20*c,20,20),(d&&!h||!d)&&k.drawImage(o,20*f,20*c)}n+=1;"stop"!==g&&
setTimeout(p,32)},m=function(){document.getElementById("fps").innerHTML=n;"stop"!==g&&(n=0,setTimeout(m,1E3))};if(d.getContext){var k=d.getContext("2d");document.getElementById("gameover").style.display="none";p();m();l()}};