var piece=function(h,i,k,a){this.structure=h||[[1]];this.top=k||0;this.left=a||0;this.color=i||"#000000";this.rotate=function(b){var a=Array(this.structure[0].length),c,g;for(c=0;c<a.length;++c){a[c]=Array(this.structure.length);for(g=0;g<a[0].length;++g)"ccw"===b?a[c][g]=this.structure[g][a.length-c-1]:"cw"===b&&(a[c][g]=this.structure[a[0].length-g-1][c])}this.structure=a}},level=function(h,i,k){this.structure=Array(i);this.pieces=[new piece([[1],[1],[1],[1]],"#8FEBE9"),new piece([[0,1,1],[1,1,
0]],"#3ED936"),new piece([[1,1,0],[0,1,1]],"#F23E22"),new piece([[1,1,1],[0,1,0]],"#B21DCC"),new piece([[0,1],[0,1],[1,1]],"#194CC2"),new piece([[1,0],[1,0],[1,1]],"#F2B022"),new piece([[1,1],[1,1]],"#F2ED50")];var a;for(a=0;a<this.structure.length;++a)this.structure[a]=Array(h);this.createPiece=function(){var b=this.pieces[Math.floor(Math.random()*this.pieces.length)];b.left=Math.floor((this.structure[0].length-b.structure[0].length)/2);b.top=0;return b};this.active=k||this.createPiece();this.checkInBoundsLeft=
function(){return 0>=this.active.left?!1:!0};this.checkInBoundsRight=function(){return this.active.left+this.active.structure[0].length>=this.structure[0].length?!1:!0};this.checkInBoundsBottom=function(){return this.active.top+this.active.structure.length>=this.structure.length?!1:!0};this.isObstructedLeft=function(){for(a=0;a<this.active.structure.length;a++)for(j=0;j<this.active.structure[a].length;j++)if(1===this.active.structure[a][j]){if(void 0!=this.structure[this.active.top+a][this.active.left+
j-1])return!0;break}return!1};this.isObstructedRight=function(){for(a=0;a<this.active.structure.length;a++)for(j=this.active.structure[a].length-1;0<=j;j--)if(1===this.active.structure[a][j]){if(void 0!=this.structure[this.active.top+a][this.active.left+j+1])return!0;break}return!1};this.isObstructedBottom=function(){for(a=this.active.structure.length-1;0<=a;a--)for(j=0;j<this.active.structure[a].length;j++)if(1===this.active.structure[a][j]&&void 0!=this.structure[this.active.top+a+1][this.active.left+
j])return!0;return!1};this.placeActive=function(){var b;for(a=0;a<this.active.structure.length;++a)for(b=0;b<this.active.structure[a].length;++b)if(1==this.active.structure[a][b])this.structure[a+this.active.top][b+this.active.left]=this.active.color};this.getFullRows=function(){var b=[],f;for(a=0;a<this.structure.length;a++)for(f=0;f<this.structure[a].length&&!(void 0===this.structure[a][f]);f++)f===this.structure[a].length-1&&b.push(a);return b};this.clearRows=function(b){for(a=0;a<b.length;a++)this.structure.splice(b[a],
1),this.structure.unshift(Array(h))};this.full=function(){if(0===this.active.top)for(a=0;a<this.structure[0].length;a++)if(void 0!=this.structure[0][a]&&this.active.left===a)return!0;return!1}},game=function(h,i,k,a){this.canvas=h||document.getElementById("level");this.level=i||new i(8,16);this.score=k||0;this.time=a||100;this.status="play";this.fps=0;this.increment=20;this.canvas.width=this.level.structure[0].length*this.increment;this.canvas.height=this.level.structure.length*this.increment;var b=
this,f=new Image;f.src="block.png";window.addEventListener("keydown",function(a){switch(a.keyCode){case 37:b.level.checkInBoundsLeft()&&!b.level.isObstructedLeft()&&(b.level.active.left-=1);break;case 38:b.level.active.rotate("cw");if(!b.level.checkInBoundsRight())b.level.active.left=b.level.structure[0].length-b.level.active.structure[0].length;if(!b.level.checkInBoundsBottom())b.level.active.top=b.level.structure.length-b.level.active.structure.length;break;case 39:b.level.checkInBoundsRight()&&
!b.level.isObstructedRight()&&(b.level.active.left+=1);break;case 40:b.level.checkInBoundsBottom()&&!b.level.isObstructedBottom()&&(b.level.active.top+=1)}},!1);this.drawActive=function(){var a,d,e=b.increment;c.fillStyle=b.level.active.color;for(a=0;a<b.level.active.structure.length;++a)for(d=0;d<b.level.active.structure[a].length;++d)1===b.level.active.structure[a][d]&&(c.fillRect((d+b.level.active.left)*e,(a+b.level.active.top)*e,e,e),c.drawImage(f,(d+b.level.active.left)*e,(a+b.level.active.top)*
e))};this.drawLevel=function(){var a,d,e=b.increment;for(a=0;a<b.level.structure.length;++a)for(d=0;d<b.level.structure[a].length;++d)if(void 0!=b.level.structure[a][d])c.fillStyle=b.level.structure[a][d],c.fillRect(d*e,a*e,e,e),c.drawImage(f,d*e,a*e)};this.dropLoop=function(){if(b.level.full())b.status="stop",console.log("game over");b.level.checkInBoundsBottom()&&!b.level.isObstructedBottom()?b.level.active.top++:(b.level.placeActive(),b.level.active=b.level.createPiece());b.level.clearRows(b.level.getFullRows());
"stop"!==b.status&&setTimeout(b.dropLoop,500)};this.renderLoop=function(){c.clearRect(0,0,b.level.structure[0].length*b.increment,b.level.structure.length*b.increment);c.fillStyle="rgb(0, 31, 0)";b.drawActive();b.drawLevel();"stop"!==b.status&&(b.fps++,setTimeout(b.renderLoop,40))};if(this.canvas.getContext){var c=this.canvas.getContext("2d");this.renderLoop();this.dropLoop()}else alert("Canvas Not Supported")};